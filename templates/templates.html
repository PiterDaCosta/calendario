{% extends "base.html" %}

{% block title %}Recurring Tasks - Task Calendar{% endblock %}

{% block content %}
<div class="templates-view">
    <div class="view-header">
        <h2>Recurring Task Templates</h2>
        <button class="btn btn-primary" onclick="openAddTemplateModal()">+ New Template</button>
    </div>

    <div class="templates-info">
        <p>Create templates for tasks that repeat on a schedule. Use cron expressions or presets to define when tasks should occur.</p>
    </div>

    <div class="templates-list" id="templatesList">
        <!-- Templates will be populated by JavaScript -->
    </div>
</div>

<!-- Template Modal -->
<div id="templateModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 id="templateModalTitle">Add Recurring Task</h3>
            <button class="btn-close" onclick="closeTemplateModal()">&times;</button>
        </div>
        <form id="templateForm" onsubmit="saveTemplate(event)">
            <input type="hidden" id="templateId">
            <div class="form-group">
                <label for="templateTitle">Task Title *</label>
                <input type="text" id="templateTitle" required placeholder="Enter task title">
            </div>
            <div class="form-group">
                <label for="templateDescription">Description</label>
                <textarea id="templateDescription" placeholder="Enter description (optional)"></textarea>
            </div>
            <div class="form-group">
                <label>Schedule Preset</label>
                <div class="preset-buttons" id="presetButtons">
                    <!-- Presets will be populated -->
                </div>
            </div>
            <div class="form-group">
                <label for="cronExpression">Cron Expression *</label>
                <input type="text" id="cronExpression" required placeholder="e.g., 0 9 * * 1-5">
                <div class="help-text">
                    Format: minute hour day-of-month month day-of-week<br>
                    Examples:<br>
                    • <code>0 9 * * *</code> - Daily at 9 AM<br>
                    • <code>0 9 * * 1-5</code> - Weekdays at 9 AM<br>
                    • <code>0 9 * * 1</code> - Every Monday at 9 AM<br>
                    • <code>0 9 1 * *</code> - First of every month at 9 AM
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="templateStartDate">Start Date</label>
                    <input type="date" id="templateStartDate">
                    <div class="help-text">Leave empty for no start limit</div>
                </div>
                <div class="form-group">
                    <label for="templateEndDate">End Date</label>
                    <input type="date" id="templateEndDate">
                    <div class="help-text">Leave empty for no end limit</div>
                </div>
            </div>
            <div class="form-group">
                <label>Preview (Next 5 occurrences)</label>
                <div id="cronPreview" class="cron-preview">
                    Enter a cron expression to see preview
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Template</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cronPresets = {};
    
    document.addEventListener('DOMContentLoaded', () => {
        loadPresets();
        loadTemplates();
        
        // Preview cron on input change
        document.getElementById('cronExpression').addEventListener('input', previewCron);
    });
    
    function loadPresets() {
        fetch('/api/templates/presets')
            .then(response => response.json())
            .then(presets => {
                cronPresets = presets;
                renderPresets();
            });
    }
    
    function renderPresets() {
        const container = document.getElementById('presetButtons');
        const presetNames = {
            'daily': 'Daily',
            'weekdays': 'Weekdays',
            'weekly_monday': 'Weekly (Mon)',
            'weekly_friday': 'Weekly (Fri)',
            'monthly_first': 'Monthly (1st)',
        };
        
        container.innerHTML = Object.entries(presetNames).map(([key, name]) => `
            <button type="button" class="btn btn-preset" onclick="selectPreset('${key}')">${name}</button>
        `).join('');
    }
    
    function selectPreset(key) {
        if (cronPresets[key]) {
            document.getElementById('cronExpression').value = cronPresets[key];
            previewCron();
        }
    }
    
    function previewCron() {
        const cronExpr = document.getElementById('cronExpression').value;
        const previewEl = document.getElementById('cronPreview');
        
        if (!cronExpr) {
            previewEl.innerHTML = 'Enter a cron expression to see preview';
            return;
        }
        
        // Simple client-side preview (we'll calculate on server for accuracy)
        try {
            // Use the cronstrue library concept - for now just show the expression
            previewEl.innerHTML = `<span class="preview-loading">Cron: ${escapeHtml(cronExpr)}</span>`;
        } catch (e) {
            previewEl.innerHTML = `<span class="preview-error">Invalid expression</span>`;
        }
    }
    
    function loadTemplates() {
        fetch('/api/templates')
            .then(response => response.json())
            .then(templates => {
                renderTemplates(templates);
            })
            .catch(error => console.error('Error loading templates:', error));
    }
    
    function renderTemplates(templates) {
        const container = document.getElementById('templatesList');
        
        if (templates.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>No recurring task templates yet.</p>
                    <p>Create a template to automatically generate tasks on a schedule.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = templates.map(template => `
            <div class="template-card ${template.is_active ? '' : 'inactive'}">
                <div class="template-header">
                    <h4>${escapeHtml(template.title)}</h4>
                    <div class="template-actions">
                        <button class="btn btn-icon" onclick="toggleTemplate(${template.id})" title="${template.is_active ? 'Deactivate' : 'Activate'}">
                            ${template.is_active ? 
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>' :
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>'
                            }
                        </button>
                        <button class="btn btn-icon" onclick="openEditTemplateModal(${template.id})" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteTemplate(${template.id})" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                ${template.description ? `<p class="template-description">${escapeHtml(template.description)}</p>` : ''}
                <div class="template-schedule">
                    <span class="schedule-label">Schedule:</span>
                    <code>${escapeHtml(template.cron_schedule)}</code>
                    <span class="schedule-status ${template.is_active ? 'active' : 'paused'}">${template.is_active ? 'Active' : 'Paused'}</span>
                </div>
                <div class="template-dates">
                    ${template.start_date || template.end_date ? `
                        <span class="dates-label">Active period:</span>
                        <span class="dates-range">
                            ${template.start_date ? formatDateDisplay(template.start_date) : 'Beginning'}
                            &rarr;
                            ${template.end_date ? formatDateDisplay(template.end_date) : 'Ongoing'}
                        </span>
                    ` : '<span class="dates-label dates-unlimited">No date limits (always active)</span>'}
                </div>
            </div>
        `).join('');
    }
    
    function formatDateDisplay(dateStr) {
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function openAddTemplateModal() {
        document.getElementById('templateModalTitle').textContent = 'Add Recurring Task';
        document.getElementById('templateId').value = '';
        document.getElementById('templateTitle').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('cronExpression').value = '';
        document.getElementById('templateStartDate').value = '';
        document.getElementById('templateEndDate').value = '';
        document.getElementById('cronPreview').innerHTML = 'Enter a cron expression to see preview';
        document.getElementById('templateModal').classList.add('active');
    }
    
    function openEditTemplateModal(id) {
        fetch(`/api/templates/${id}`)
            .then(response => response.json())
            .then(template => {
                document.getElementById('templateModalTitle').textContent = 'Edit Recurring Task';
                document.getElementById('templateId').value = template.id;
                document.getElementById('templateTitle').value = template.title;
                document.getElementById('templateDescription').value = template.description || '';
                document.getElementById('cronExpression').value = template.cron_schedule;
                document.getElementById('templateStartDate').value = template.start_date || '';
                document.getElementById('templateEndDate').value = template.end_date || '';
                previewCron();
                document.getElementById('templateModal').classList.add('active');
            });
    }
    
    function closeTemplateModal() {
        document.getElementById('templateModal').classList.remove('active');
    }
    
    function saveTemplate(event) {
        event.preventDefault();
        
        const id = document.getElementById('templateId').value;
        const startDate = document.getElementById('templateStartDate').value;
        const endDate = document.getElementById('templateEndDate').value;
        
        const data = {
            title: document.getElementById('templateTitle').value,
            description: document.getElementById('templateDescription').value,
            cron_schedule: document.getElementById('cronExpression').value,
            start_date: startDate || null,
            end_date: endDate || null,
            is_active: true
        };
        
        const url = id ? `/api/templates/${id}` : '/api/templates';
        const method = id ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then((savedTemplate) => {
            closeTemplateModal();
            loadTemplates();
            
            // Regenerate tasks for this template
            if (id) {
                // If editing, regenerate future tasks
                fetch(`/api/templates/${id}/regenerate`, { method: 'POST' })
                    .then(() => console.log('Tasks regenerated'));
            } else {
                // If new, generate tasks for it
                generateRecurringTasks();
            }
        })
        .catch(error => {
            console.error('Error saving template:', error);
            alert('Error saving template. Please check your cron expression.');
        });
    }
    
    function toggleTemplate(id) {
        fetch(`/api/templates/${id}/toggle`, { method: 'POST' })
            .then(response => response.json())
            .then(() => loadTemplates())
            .catch(error => console.error('Error toggling template:', error));
    }
    
    function deleteTemplate(id) {
        if (!confirm('Are you sure you want to delete this template? Generated tasks will not be removed.')) {
            return;
        }
        
        fetch(`/api/templates/${id}`, { method: 'DELETE' })
            .then(() => loadTemplates())
            .catch(error => console.error('Error deleting template:', error));
    }
    
    function generateRecurringTasks() {
        const today = new Date();
        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        
        fetch('/api/generate-recurring', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: today.toISOString(),
                end_date: nextWeek.toISOString()
            })
        });
    }
</script>
{% endblock %}
